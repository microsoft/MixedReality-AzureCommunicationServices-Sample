# Azure Function App for ACS

These Azure Functions wrap Azure Communication Service's Identity APIs, allowing an application to use these APIs for multi-tenant AAD authentication scenarios. For more information on multi-tenant support with Azure Communication Service's visit the the ACS [documentation](https://docs.microsoft.com/en-us/azure/communication-services/concepts/interop/custom-teams-endpoint-authentication-overview#case-2-example-of-a-multi-tenant-application) site.

## Setting up cloud service
1. Create Azure Function App resource with .Net 6.0 on Windows environment
2. Deploy Function App to your resource
3. Now secure access to the Function App resource by adding AAD authentication. This walk-through gives the quick steps on how to add authentication to a Function App. If more information is required please visit [Authentication and authorization in Azure App Service and Azure Functions](https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#authentication-flow).
   1. Go to Azure Function App resources's 'Settings > Authentication' tab, and click "Add identity provider"
   2. Select the "Microsoft" identity provider.
   3. Select "Create new app registration" under "App registration type". Note, you can use an existing app registration, but for simplicity this walk-through will create a new one.
   4. Select the appropriate "Account types". This walk-through will use "Any Azure AD directory - Multi-tenant".
   5. Select "Require authentication" for "Restrict access".
   6. Since setting up a web API, it's recommended to select the "HTTP 401" error for "Unauthenticated requests".
   7. Keep "Token store" enabled.
   8. After clicking "Next" select the Microsoft Graph permissions the web API will request. Keep the default "User.Read" permission, and then click "Add".  You can add additional permissions later if needed.
   9. A new web app registration has now been created. 
4. Take the time to verify and understand the configuration of the new web app registration. Note, some slight modifications are needed to this app registration that has been created, in order to support the multi-tenant scenario.
   1. Go to the app registration created in step 3.
   2. In the 'Overview' section copy and save the 'Application (client) ID' and Directory (tenant) ID'. These value will be needed in a later step.
   2. Click the 'Manage > Authentication' tab.
   3. Examine the "Web" heading and see the redirect URI for the newly created Azure Function; for example, https://<your-azure-function-name>.azurewebsites.net/.auth/login/aad/callback.
   4. Examine the "Supported account types". The automatic app registration has set "Single tenant" for the account types, but "Multi tenant" is wanted for this demo. So change "Supported account types" to "Multi Tenant" and click "Save"
   5. Click 'Manage > Certificates & secrets' tab
   6. There should be secret entitled 'Generated by App Service'. This secret is used by Function App to prove the application's identity when requested a user token.
   6. Click the 'Manager > API permissions' tab.
   7. Examine the permissions. These are the permissions the Function App will require when the user authenticates with AAD. Keep the default Microsoft Graph permission User.Read, as this will be needed for the Function App to read the user's tenant information.
   7. Click the 'Manage > Expose an API' tab
   8. Edit the 'Application ID URI' so that multi-tenant accounts are supported. By default the URI is "api://<client_id>", which means the API will only be accessible by users in API's own tenant. This walk-through desired that this API is accessible by users in any tenant, so the URI needs to be changed to "api://<tenant_id>/<client_id>".  The URI can also be set to "https://<tenant_name>.onmicrosoft.com/<some_name>", but for simplicity use the "api://<tenant_id>/<client_id>".
   8. Next examine the scopes. The Function App automatically exposes an API with default scope of "user_impersonation". This scope will be used by a native application when requesting an AAD token. Copy the full scope URI for use with your native application later. The scope URI should be "api://<tenant_id>/<client_id>/user_impersonation".  Copy and save this scope URI for later.
8. Add the web application scoped resource to the Function App.
   1.  Go to back to the Azure Function App resource and select  'Settings > Authentication' tab. 
   2. Click the 'Edit' button for the Microsoft identity provider added earlier.
   3. Under the 'Allow token audiences' edit the default audience URI to the new multi-tenant URI created earlier. The URI should be changed from 'api://<client_id>' to 'api://<tenant_id>/<client_id>'.
   4. Click 'Save' to commit the changes
9. Finish configuring the Azure Function app.
   1. Go to back to the Azure Function App resource and select  'Settings > Configuration' tab. 
   1. Add a new application setting called "COMMUNICATIONS_ENDPOINT" and set its value to ACS resource endpoint; for example, "https://<your-acs-resource-name>.communication.azure.com". This setting is used by the function app code when connecting with the ACS resource.
   2. Verify that there's a setting called 'MICROSOFT_PROVIDER_AUTHENTICATION_SECRET'. This value is the same value as the web app registration's secret titled 'Generated by App Service', and is used by the function app when requesting a user token.
   3. Click "Save" when done editing the Function App's configuration.
10. The next steps will give the Function App access to the existing Azure Communication Services resource.
   1. Go to back to the Azure Function App resource and select  'Settings > Identity' tab. 
   2. Turn "On" the "System assigned" managed identity, and click "Save" and confirm.
   3. After the managed identity has been created, go to the Azure Communication Services resource and select the 'Access control (IAM)' tab.
   4. Click the "Add button to add a new role assignment for the ACS resource.
   5. Select the "Contributor" role, and click "Next"
   6. Assign access to a "Manage identity", and search for and select the Function App created in this walk-through.  
   7. Finally, click "Next" and "Review + Assign" to complete the role assignment.



11.  Your Azure Functions are setup, and can be used to obtain an ACS token via AAD authentication. To use these functions, however, you first need to setup your native application registration...

## Setting up native application registration
1. The next steps will walk through how to configure the web application registration, created during the [Setting up cloud service](#setting-up-cloud-service) section, as a native application as well. However, if desired, an existing native application can be used instead, or new native application can be created. For simplicity, this walk-through will convert the web application into a web + native application.
2. From the Azure portal, go to the Azure Active Directory service and select 'Manage > App registrations"
3. Find the web application registered in [Setting up cloud service](#setting-up-cloud-service), and go the registration details.
4. Add the support for a desktop application.
   1. Go to 'Manage > Authentication' and click 'Add a platform'
   2. Select "Mobile and desktop applications"
   3. In the URI field enter "http://localhost" so that authentication can be done in the Unity Editor. At the moment the ACS Unity sample is setup to use http://localhost as the redirect URI. When deploying to HoloLens, an additional redirect URI will to added.
   4. Complete configuration by clicking the 'Configure' button.
7. Now time to add additional API permissions for the native application.
   1. Select "Manage > API permissions".
   2. Leave the default Microsoft Graph "User.Read" permission.
   3. Click "Add a permission" and select "Azure Communication Services" under the "Microsoft APIs" header.
   4. Since the sample ACS app makes Teams calls and and participates in Teams chat, select the "Teams.ManageCalls" and "Teams.ManageChat" permissions and click "Add permissions"
   5. Click 'Add permissions' again and search for the new web API that was created in [Setting up cloud service](#setting-up-cloud-service), under the "My APIs" heading.
   6. Next select the permission needed to consume the web API (likely called "user_impersonation"), and click "Add permissions".
8. (Optional) If setting up a separate native application registration from the web application, go back to the web application registration so to authorize the native client application access to the web API.
   1. From the web application go to 'Manage > Expose an API' and click "Add a client application' under the 'Authorized client applications' heading.
   2. Add in the native application's client id, and select the custom API scope created earlier (likely user_impersonation).
   3. Click 'Add application' to finish authorization.
9. Your native and web application registration is now complete. The desktop application can now be configured with the necessary IDs and scopes.


## Setting local debugging
If you want to test these functions locally, add a file called `local.settings.json` under the `communications-helper` directory. The content of ths JSON file should be as follows, filling in the COMMUNICATIONS_ENDPOINT:

```json
{
  "IsEncrypted": false,
  "Values": {
    "COMMUNICATIONS_ENDPOINT": "https://<PutYourResourceNameHere>.communication.azure.com"
  }
}
```


